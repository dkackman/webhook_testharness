extends layout

include mixins/card

block content
  .container-fluid
    h2.mb-3= title

    //- Asset IDs Input Form
    .card.mb-3
      +cardHeaderSimple('Asset IDs')
      .card-body
        form#asset-form
          .input-group
            input#asset-ids-input.form-control.font-monospace(
              type="text"
              placeholder="Enter asset IDs (comma-separated)"
              value=asset_ids
            )
            button.btn.btn-primary(type="submit") Lookup

    //- Loading State
    #loading.text-center.p-4(style="display: none;")
      .spinner-border.text-primary.mb-2(role="status")
        span.visually-hidden Loading...
      p.text-muted Loading asset details...

    //- Error State
    #error.alert.alert-danger(style="display: none;")
      strong Error:
      span#error-message

    //- Asset Data
    .card#assets-container(style="display: none;")
      +cardHeaderSimple('Asset Details')
      .card-body.p-0
        pre#assets-data.m-0.p-3.font-monospace.small.event-details

  script.
    (function() {
      var $form = document.getElementById('asset-form');
      var $input = document.getElementById('asset-ids-input');
      var $loading = document.getElementById('loading');
      var $error = document.getElementById('error');
      var $errorMessage = document.getElementById('error-message');
      var $container = document.getElementById('assets-container');
      var $data = document.getElementById('assets-data');

      function showLoading() {
        $loading.style.display = 'block';
        $error.style.display = 'none';
        $container.style.display = 'none';
      }

      function showError(message) {
        $loading.style.display = 'none';
        $error.style.display = 'block';
        $errorMessage.textContent = message;
        $container.style.display = 'none';
      }

      function createColoredSpan(text, className) {
        var span = document.createElement('span');
        span.className = className;
        span.textContent = text;
        return span;
      }

      function renderJsonWithSyntax(container, data) {
        container.textContent = '';
        var jsonStr = JSON.stringify(data, null, 2);
        var fragment = document.createDocumentFragment();
        var pattern = /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g;
        var lastIndex = 0;
        var result;

        while ((result = pattern.test(jsonStr), pattern.lastIndex > lastIndex || result)) {
          if (!result) break;
          var matchStart = pattern.lastIndex - RegExp.lastMatch.length;
          if (matchStart > lastIndex) {
            fragment.appendChild(document.createTextNode(jsonStr.slice(lastIndex, matchStart)));
          }

          var value = RegExp.lastMatch;
          var cls = 'json-number';

          if (/^"/.test(value)) {
            if (/:$/.test(value)) {
              cls = 'json-key';
            } else {
              cls = 'json-string';
            }
          } else if (/true|false/.test(value)) {
            cls = 'json-boolean';
          } else if (/null/.test(value)) {
            cls = 'json-null';
          }

          fragment.appendChild(createColoredSpan(value, cls));
          lastIndex = pattern.lastIndex;
        }

        if (lastIndex < jsonStr.length) {
          fragment.appendChild(document.createTextNode(jsonStr.slice(lastIndex)));
        }

        container.appendChild(fragment);
      }

      function showData(data) {
        $loading.style.display = 'none';
        $error.style.display = 'none';
        $container.style.display = 'block';
        renderJsonWithSyntax($data, data);
      }

      function fetchAssets(assetIds) {
        if (!assetIds) {
          return;
        }

        showLoading();

        var url = new URL(window.location);
        url.searchParams.set('asset_ids', assetIds);
        window.history.pushState({}, '', url);

        fetch('/proxy/get_assets?asset_ids=' + encodeURIComponent(assetIds))
          .then(function(response) {
            if (!response.ok) {
              return response.json().then(function(err) {
                throw new Error(err.message || err.error || 'Failed to fetch assets');
              });
            }
            return response.json();
          })
          .then(showData)
          .catch(function(error) {
            console.error('Error:', error);
            showError(error.message);
          });
      }

      $form.addEventListener('submit', function(e) {
        e.preventDefault();
        var assetIds = $input.value.trim();
        if (assetIds) {
          fetchAssets(assetIds);
        }
      });

      var initialAssetIds = '#{asset_ids}';
      if (initialAssetIds) {
        fetchAssets(initialAssetIds);
      }
    })();
